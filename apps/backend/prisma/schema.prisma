generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Conversation {
  id            String             @id @default(cuid())
  sessionId     String
  contactId     String
  contactName   String?
  contactPhone  String
  contactAvatar String?
  lastMessage   String?
  lastMessageAt DateTime?
  unreadCount   Int                @default(0)
  isGroup       Boolean            @default(false)
  status        ConversationStatus @default(OPEN)
  activeFlowId  String?
  labels        String[]           @default([])
  tenantId      String
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  session       WhatsappSession    @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tenant        Tenant             @relation(fields: [tenantId], references: [id])
  messages      Message[]

  @@index([tenantId])
  @@index([sessionId, contactId])
  @@index([sessionId])
  @@unique([sessionId, contactId])
  @@map("conversations")
}

model Message {
  id             String        @id @default(cuid())
  conversationId String
  content        String
  mediaUrl       String?
  mediaType      String?
  fromMe         Boolean       @default(false)
  timestamp      DateTime
  status         MessageStatus @default(SENT)
  createdAt      DateTime      @default(now())
  conversation   Conversation  @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@map("messages")
}

model ContactFlowState {
  id              String   @id @default(cuid())
  sessionId       String
  contactId       String
  workflowId      String
  currentNodeId   String
  executionId     String?
  variables       Json     @default("{}")
  expiresAt       DateTime
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([sessionId, contactId])
  @@map("contact_flow_states")
}

model Workflow {
  id                  String                @id
  tenantId            String
  name                String
  description         String?
  nodes               Json
  edges               Json
  isActive            Boolean               @default(false)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  shareable_workflows ShareableWorkflow[]
  workflow_executions WorkflowExecution[]
  tenants             Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("workflows")
}

model WorkflowExecution {
  id                String            @id
  tenantId          String
  workflowId        String
  sessionId         String
  contactId         String
  currentNodeId     String?
  status            String
  context           Json
  interactionCount  Int               @default(0)
  startedAt         DateTime          @default(now())
  updatedAt         DateTime
  expiresAt         DateTime
  completedAt       DateTime?
  error             String?
  whatsapp_sessions WhatsappSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  tenants           Tenant            @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflows         Workflow          @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@index([status, expiresAt])
  @@index([tenantId])
  @@index([tenantId, sessionId, contactId, status])
  @@index([tenantId, workflowId])
  @@map("workflow_executions")
}

model WhatsappSession {
  id                     String                   @id
  tenantId               String
  name                   String
  status                 String
  qrCode                 String?
  phoneNumber            String?
  createdAt              DateTime                 @default(now())
  updatedAt              DateTime
  isBusiness             Boolean                  @default(false)
  conversations          Conversation[]
  whatsapp_auth_states   WhatsappAuthState?
  whatsapp_group_configs WhatsappGroupConfig[]
  whatsapp_labels        WhatsappLabel[]
  tenants                Tenant                   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  workflow_executions    WorkflowExecution[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@map("whatsapp_sessions")
}

model WhatsappLabel {
  id                String            @id
  sessionId         String
  labelId           String
  name              String
  color             Int?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  whatsapp_sessions WhatsappSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, labelId])
  @@index([sessionId])
  @@map("whatsapp_labels")
}

model WhatsappGroupConfig {
  id                String            @id
  sessionId         String
  groupId           String
  name              String
  enabled           Boolean           @default(false)
  workflowIds       String[]          @default([])
  createdAt         DateTime          @default(now())
  updatedAt         DateTime
  whatsapp_sessions WhatsappSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, groupId])
  @@index([sessionId])
  @@map("whatsapp_group_configs")
}

model WhatsappChatLabel {
  id        String   @id
  sessionId String
  chatId    String
  labelId   String
  createdAt DateTime @default(now())

  @@unique([sessionId, chatId, labelId])
  @@index([sessionId, chatId])
  @@index([sessionId])
  @@map("whatsapp_chat_labels")
}

model WhatsappAuthState {
  id                String            @id
  sessionId         String            @unique
  creds             Json
  keys              Json
  updatedAt         DateTime
  whatsapp_sessions WhatsappSession   @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  @@map("whatsapp_auth_states")
}

model User {
  id                  String                @id
  tenantId            String
  email               String
  password            String
  name                String?
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  licenseExpiresAt    DateTime?
  licenseStatus       LicenseStatus         @default(TRIAL)
  trialEndsAt         DateTime?
  trialStartedAt      DateTime?             @default(now())
  role                Role                  @default(USER)
  shareable_workflows ShareableWorkflow[]
  tenants             Tenant                @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, email])
  @@index([email])
  @@index([role])
  @@index([tenantId])
  @@map("users")
}

model Tenant {
  id                  String                @id
  name                String
  email               String                @unique
  isActive            Boolean               @default(true)
  createdAt           DateTime              @default(now())
  updatedAt           DateTime
  conversations       Conversation[]
  users               User[]
  whatsapp_sessions   WhatsappSession[]
  workflow_executions WorkflowExecution[]
  workflows           Workflow[]
  @@map("tenants")
}

model Tag {
  id          String   @id
  tenantId    String
  name        String
  color       String?  @default("#8b5cf6")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("tags")
}

model ShareableWorkflow {
  id          String    @id
  workflowId  String
  createdBy   String
  importCount Int       @default(0)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  users       User      @relation(fields: [createdBy], references: [id])
  workflows   Workflow  @relation(fields: [workflowId], references: [id], onDelete: Cascade)
  @@map("shareable_workflows")
}

model GlobalConfig {
  id                       String   @id
  minDelay                 Int      @default(3000)
  maxDelay                 Int      @default(8000)
  maxMsgsPerMinute         Int      @default(20)
  proportionalDelayEnabled Boolean  @default(true)
  updatedAt                DateTime
  @@map("global_configs")
}

model ExecutionLog {
  id          String   @id
  tenantId    String
  executionId String
  nodeId      String?
  eventType   String
  data        Json
  createdAt   DateTime @default(now())

  @@index([createdAt])
  @@index([executionId])
  @@index([tenantId])
  @@map("execution_logs")
}

model ContactTag {
  id        String   @id
  tenantId  String
  sessionId String
  contactId String
  tags      String[] @default([])
  createdAt DateTime @default(now())
  updatedAt DateTime

  @@unique([tenantId, sessionId, contactId])
  @@index([tenantId])
  @@index([tenantId, sessionId, contactId])
  @@index([tenantId, sessionId])
  @@map("contact_tags")
}

enum ConversationStatus {
  OPEN
  PENDING
  RESOLVED
  BOT
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
  VIP
}

enum LicenseStatus {
  TRIAL
  ACTIVE
  EXPIRED
  SUSPENDED
}
